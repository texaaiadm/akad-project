<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkadBuilder Pro - Online Collaboration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; }
            .print-hidden { display: none !important; }
            .print-grayscale { filter: grayscale(100%); }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 2.5cm !important;
                box-shadow: none !important;
                border: none !important;
                max-width: none !important;
            }
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        .canvas-container { touch-action: none; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Smooth transitions for elements */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Navbar -->
    <nav class="bg-emerald-800 text-white p-4 shadow-md print-hidden sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="file-text"></i>
                <div>
                    <h1 class="text-xl font-bold hidden md:block">AkadBuilder Pro <span class="text-xs font-normal opacity-75 ml-2 bg-emerald-700 px-2 py-0.5 rounded">Collaborative</span></h1>
                    <h1 class="text-xl font-bold md:hidden">AkadBuilder</h1>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div id="sync-status" class="hidden md:flex items-center gap-2 mr-2">
                    <span class="text-xs text-emerald-200 flex items-center gap-1 opacity-50"><i data-lucide="wifi-off" class="w-3 h-3"></i> Offline</span>
                </div>

                <button id="btn-share" class="flex items-center gap-2 px-3 py-2 rounded-lg font-semibold text-sm transition-all shadow-sm bg-emerald-600 text-white hover:bg-emerald-500">
                    <i data-lucide="share-2"></i>
                    <span class="hidden sm:inline" id="share-text">Bagikan Link</span>
                </button>

                <button onclick="window.print()" class="flex items-center gap-2 bg-white text-emerald-900 px-4 py-2 rounded-lg font-semibold hover:bg-emerald-50 transition-colors shadow-sm">
                    <i data-lucide="printer"></i>
                    <span class="hidden sm:inline">Cetak PDF</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Info Banner -->
    <div id="info-banner" class="bg-blue-50 border-b border-blue-100 p-2 text-center text-sm text-blue-800 print-hidden">
        <p class="flex justify-center items-center gap-2">
            <i data-lucide="info" size="16" class="shrink-0"></i>
            <span>Setiap perubahan akan tersimpan otomatis. Link ini bisa dibuka bersama oleh semua pihak.</span>
        </p>
    </div>

    <div class="max-w-[1400px] mx-auto p-4 md:p-8 flex flex-col xl:flex-row gap-8">
        
        <!-- KOLOM KIRI: EDITOR -->
        <div class="w-full xl:w-2/5 space-y-6 print-hidden">
            
            <!-- Pengaturan Umum -->
            <div class="bg-white p-6 rounded-xl shadow border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="settings"></i> Pengaturan Umum
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Tanggal Akad</label>
                        <input type="date" id="input-start-date" class="w-full p-2 border rounded focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Periode Bagi Hasil</label>
                        <select id="input-frequency" class="w-full p-2 border rounded bg-white focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="harian">Harian</option>
                            <option value="mingguan">Mingguan</option>
                            <option value="2 minggu sekali">2 Minggu Sekali</option>
                            <option value="bulanan">Bulanan</option>
                            <option value="tahunan">Tahunan</option>
                        </select>
                    </div>
                </div>
                <div id="share-warning" class="mt-4 p-3 rounded text-sm font-medium flex justify-between items-center bg-red-100 text-red-800 transition-colors">
                    <span id="total-share-text">Total Bagi Hasil: 0%</span>
                    <span id="share-check-icon"></span>
                </div>
            </div>

            <!-- List Anggota -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Data Pihak / Anggota</h3>
                    <button id="btn-add-member" class="flex items-center gap-1 text-xs bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 transition">
                        <i data-lucide="plus" size="14"></i> Tambah Pihak
                    </button>
                </div>

                <div id="members-container" class="space-y-4">
                    <!-- Dinamis melalui JS -->
                </div>
            </div>
        </div>

        <!-- KOLOM KANAN: PREVIEW -->
        <div class="w-full xl:w-3/5 flex justify-center bg-gray-200 xl:bg-transparent p-2 xl:p-0 rounded overflow-x-auto">
            <div id="print-area" class="bg-white w-full max-w-[210mm] min-h-[297mm] p-12 shadow-2xl print:shadow-none print:w-full print:max-w-none print:p-0 text-gray-900 leading-relaxed relative flex flex-col">
                <!-- Content Preview Area -->
                <div class="text-center mb-8 border-b-2 border-black pb-4">
                    <h1 class="text-2xl font-bold uppercase tracking-wide">Akad Syirkah Musyarakah</h1>
                    <p class="text-sm font-serif italic mt-1" id="preview-no-akad">Nomor: ...</p>
                </div>
                <div class="text-center font-serif text-xl mb-6">Bismillāhirraḥmānirraḥīm</div>
                <div class="text-justify text-sm md:text-base space-y-6 font-serif flex-grow">
                    <p>Pada hari ini, <strong id="preview-date">...</strong>, kami yang bertanda tangan di bawah ini sepakat melakukan kerja sama usaha (Syirkah) dengan ketentuan sebagai berikut:</p>
                    <div>
                        <h3 class="font-bold mb-2 bg-gray-100 print:bg-transparent inline-block px-2 py-1 rounded">1️⃣ Para Pihak</h3>
                        <div id="preview-members-list" class="pl-4 space-y-4"></div>
                    </div>
                    <div>
                        <h3 class="font-bold mb-1 bg-gray-100 print:bg-transparent inline-block px-2 py-1 rounded">2️⃣ Pembagian Keuntungan (Nisbah)</h3>
                        <div class="pl-4">
                            <p>Keuntungan bersih usaha (Net Profit) akan dibagikan secara <strong id="preview-frequency">...</strong> dengan proporsi:</p>
                            <ul id="preview-shares-list" class="list-disc ml-6 mt-2 mb-2"></ul>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold mb-1 bg-gray-100 print:bg-transparent inline-block px-2 py-1 rounded">3️⃣ Ketentuan Usaha</h3>
                        <ul class="list-disc ml-8 pl-4 space-y-1">
                            <li>Kerugian finansial ditanggung oleh para pemodal sesuai porsi modal.</li>
                            <li>Kejujuran dan transparansi adalah landasan utama akad ini.</li>
                        </ul>
                    </div>
                </div>
                <!-- Footer -->
                <div class="mt-12 pt-4 border-t-2 border-gray-800 break-inside-avoid">
                    <div id="preview-signatures-grid" class="grid grid-cols-2 md:grid-cols-3 gap-y-12 gap-x-8 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-camera" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md text-center">
            <video id="camera-video" autoplay playsinline class="w-full bg-black rounded mb-4"></video>
            <div class="flex gap-2 justify-center">
                <button id="btn-capture" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 flex items-center gap-2"><i data-lucide="camera" size="18"></i> Ambil Foto</button>
                <button id="btn-close-camera" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBYHrCidW3vrJHldgEbHqjeYYphl5f7DlM",
            authDomain: "texa-f4b30.firebaseapp.com",
            projectId: "texa-f4b30",
            storageBucket: "texa-f4b30.firebasestorage.app",
            messagingSenderId: "922894298029",
            appId: "1:922894298029:web:5c1bf375c2bb61b0cb8f24",
            measurementId: "G-QVBGFMKBG9"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'akad-syirkah-pro-v1';

        // --- GLOBAL STATE ---
        let state = {
            generalData: { startDate: new Date().toISOString().split('T')[0], frequency: 'bulanan' },
            members: [
                { id: "1", role: 'Pihak Pertama (Owner)', name: '', share: 60, photo: null, signature: null, useMaterai: true },
                { id: "2", role: 'Pihak Kedua (Pengelola)', name: '', share: 40, photo: null, signature: null, useMaterai: false },
            ],
            sessionId: null,
            user: null,
            syncStatus: 'offline',
            syncError: null
        };

        let autoSaveTimeout = null;
        let activeMemberId = null;
        let mediaStream = null;

        // --- CORE FUNCTIONS ---
        const updateSyncUI = () => {
            const container = document.getElementById('sync-status');
            container.classList.remove('hidden');
            let icon = 'cloud-off', text = 'Offline', color = 'text-gray-400';
            
            if (state.syncStatus === 'syncing') { icon = 'refresh-cw'; text = 'Menyimpan...'; color = 'text-emerald-200 animate-pulse'; }
            else if (state.syncStatus === 'saved') { icon = 'cloud'; text = 'Tersimpan'; color = 'text-emerald-300'; }
            else if (state.syncStatus === 'error') { icon = 'alert-circle'; text = 'Error Sync'; color = 'text-red-300'; }
            
            container.innerHTML = `<span class="text-xs ${color} flex items-center gap-1" title="${state.syncError || ''}"><i data-lucide="${icon}" class="w-3 h-3 ${state.syncStatus === 'syncing' ? 'loading-spinner' : ''}"></i> ${text}</span>`;
            lucide.createIcons();
        };

        const debouncedSave = () => {
            state.syncStatus = 'syncing';
            updateSyncUI();
            if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                if (!auth.currentUser || !state.sessionId) return;
                try {
                    const docRef = doc(db, 'akad_sessions', state.sessionId);
                    await setDoc(docRef, {
                        generalData: state.generalData,
                        members: state.members,
                        lastUpdated: serverTimestamp()
                    }, { merge: true });
                    state.syncStatus = 'saved';
                    state.syncError = null;
                } catch (e) {
                    console.error("Firestore Save Error:", e);
                    state.syncStatus = 'error';
                    state.syncError = e?.message || 'Save failed';
                }
                updateSyncUI();
            }, 1500);
        };

        // --- RENDERERS ---
        const renderMembers = () => {
            const container = document.getElementById('members-container');
            
            state.members.forEach(member => {
                let existingDiv = document.getElementById(`member-card-${member.id}`);
                
                if (!existingDiv) {
                    existingDiv = document.createElement('div');
                    existingDiv.id = `member-card-${member.id}`;
                    existingDiv.className = "bg-white p-5 rounded-xl shadow border border-gray-200 relative group fade-in";
                    container.appendChild(existingDiv);
                }

                const isRoleFocused = document.activeElement && document.activeElement.id === `input-role-${member.id}`;
                const isNameFocused = document.activeElement && document.activeElement.id === `input-name-${member.id}`;
                const isShareFocused = document.activeElement && document.activeElement.id === `input-share-${member.id}`;

                existingDiv.innerHTML = `
                    <button onclick="removeMember('${member.id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition"><i data-lucide="trash-2" size="18"></i></button>
                    <div class="space-y-4">
                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-8">
                                <label class="block text-xs text-gray-500 uppercase mb-1">Peran</label>
                                <input type="text" id="input-role-${member.id}" value="${member.role}" oninput="updateMemberState('${member.id}', 'role', this.value)" class="w-full p-2 border rounded text-sm font-semibold text-emerald-800 bg-emerald-50 focus:bg-white outline-none">
                            </div>
                            <div class="col-span-4">
                                <label class="block text-xs text-gray-500 uppercase mb-1">Share %</label>
                                <input type="number" id="input-share-${member.id}" value="${member.share}" oninput="updateMemberState('${member.id}', 'share', this.value)" class="w-full p-2 border rounded text-center font-mono outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 uppercase mb-1">Nama Lengkap</label>
                            <input type="text" id="input-name-${member.id}" value="${member.name}" oninput="updateMemberState('${member.id}', 'name', this.value)" class="w-full p-2 border rounded text-lg font-medium outline-none" placeholder="Isi nama...">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center">
                                <span class="block text-[10px] text-gray-400 uppercase mb-1">Foto Selfie</span>
                                <div class="border rounded bg-gray-50 p-2 min-h-[120px] flex items-center justify-center">
                                    ${member.photo ? `
                                        <div class="relative"><img src="${member.photo}" class="h-28 rounded shadow-sm border"><button onclick="updateMemberState('${member.id}', 'photo', null)" class="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full"><i data-lucide="x" size="12"></i></button></div>
                                    ` : `<button onclick="openCamera('${member.id}')" class="flex flex-col items-center gap-1 text-gray-400 hover:text-emerald-600"><i data-lucide="camera" size="24"></i><span class="text-[10px]">Ambil Foto</span></button>`}
                                </div>
                            </div>
                            <div class="text-center">
                                <span class="block text-[10px] text-gray-400 uppercase mb-1">Tanda Tangan</span>
                                <div class="border rounded bg-white p-1 relative">
                                    <canvas id="canvas-${member.id}" width="200" height="100" class="w-full h-[110px] cursor-crosshair"></canvas>
                                    <button onclick="clearSig('${member.id}')" class="absolute top-1 right-1 text-red-400"><i data-lucide="refresh-cw" size="12"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pt-2 border-t">
                            <input type="checkbox" id="mat-${member.id}" ${member.useMaterai ? 'checked' : ''} onchange="updateMemberState('${member.id}', 'useMaterai', this.checked)">
                            <label for="mat-${member.id}" class="text-xs text-gray-600 flex items-center gap-1 cursor-pointer"><i data-lucide="stamp" size="12"></i> Gunakan Materai Digital</label>
                        </div>
                    </div>
                `;

                if (isRoleFocused) document.getElementById(`input-role-${member.id}`).focus();
                if (isNameFocused) document.getElementById(`input-name-${member.id}`).focus();
                if (isShareFocused) document.getElementById(`input-share-${member.id}`).focus();
                
                initCanvas(member);
            });

            const currentIds = state.members.map(m => `member-card-${m.id}`);
            Array.from(container.children).forEach(child => {
                if (!currentIds.includes(child.id)) child.remove();
            });

            lucide.createIcons();
            renderPreview();
        };

        const renderPreview = () => {
            const total = state.members.reduce((a, b) => a + (parseFloat(b.share) || 0), 0);
            document.getElementById('preview-date').innerText = new Date(state.generalData.startDate).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
            document.getElementById('preview-frequency').innerText = state.generalData.frequency;
            document.getElementById('total-share-text').innerText = `Total Bagi Hasil: ${total}%`;
            
            const warn = document.getElementById('share-warning');
            warn.className = `mt-4 p-3 rounded text-sm font-medium flex justify-between items-center ${total === 100 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;

            document.getElementById('preview-members-list').innerHTML = state.members.map((m,i) => `
                <div class="flex gap-2"><span>${i+1}.</span><div class="border-b border-dotted border-gray-400 w-full flex justify-between"><b>${m.name || '...'}</b><i class="text-xs text-gray-400">(${m.role})</i></div></div>
            `).join('');

            document.getElementById('preview-shares-list').innerHTML = state.members.map(m => `<li>${m.role}: <b>${m.share}%</b></li>`).join('');

            document.getElementById('preview-signatures-grid').innerHTML = state.members.map(m => `
                <div class="flex flex-col items-center relative">
                    <span class="text-xs font-bold mb-1">${m.role}</span>
                    <div class="h-24 w-full flex items-center justify-center relative">
                        ${m.useMaterai ? '<div class="absolute border border-blue-200 bg-blue-50 text-[8px] text-blue-300 p-1 rotate-12">MATERAI 10000</div>' : ''}
                        ${m.signature ? `<img src="${m.signature}" class="max-h-20 mix-blend-multiply">` : ''}
                    </div>
                    <span class="border-t border-black w-full text-xs font-bold pt-1">${m.name || '(................)'}</span>
                </div>
            `).join('');
        };

        // --- HANDLERS ---
        window.updateMemberState = (id, field, value) => {
            const member = state.members.find(m => m.id === id);
            if (member) {
                member[field] = (field === 'share') ? parseFloat(value) || 0 : value;
                renderPreview();
                debouncedSave();
            }
        };

        window.removeMember = (id) => {
            if (state.members.length <= 1) return;
            state.members = state.members.filter(m => m.id !== id);
            renderMembers();
            debouncedSave();
        };

        window.openCamera = async (id) => {
            activeMemberId = id;
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('camera-video');
                video.srcObject = mediaStream;
                document.getElementById('modal-camera').classList.remove('hidden');
            } catch (e) { 
                console.error("Camera Error:", e);
                alert("Gagal membuka kamera. Mohon berikan izin kamera pada browser Anda."); 
            }
        };

        document.getElementById('btn-capture').onclick = () => {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = 400; canvas.height = 300;
            canvas.getContext('2d').drawImage(video, 0, 0, 400, 300);
            updateMemberState(activeMemberId, 'photo', canvas.toDataURL('image/jpeg', 0.7));
            document.getElementById('btn-close-camera').click();
            renderMembers();
        };

        document.getElementById('btn-close-camera').onclick = () => {
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            document.getElementById('modal-camera').classList.add('hidden');
        };

        const initCanvas = (member) => {
            const canvas = document.getElementById(`canvas-${member.id}`);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            
            if (member.signature) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                img.src = member.signature;
            }

            let drawing = false;
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x: x * (canvas.width / rect.width), y: y * (canvas.height / rect.height) };
            };
            canvas.onmousedown = canvas.ontouchstart = (e) => { drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
            canvas.onmousemove = canvas.ontouchmove = (e) => { if (!drawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); e.preventDefault(); };
            window.onmouseup = canvas.ontouchend = () => { if (drawing) { drawing = false; updateMemberState(member.id, 'signature', canvas.toDataURL()); } };
        };

        window.clearSig = (id) => {
            const canvas = document.getElementById(`canvas-${id}`);
            if (canvas) {
                canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
                updateMemberState(id, 'signature', null);
            }
        };

        document.getElementById('btn-add-member').onclick = () => {
            const newId = Date.now().toString();
            state.members.push({ id: newId, role: `Mitra ${state.members.length+1}`, name: '', share: 0, photo: null, signature: null, useMaterai: false });
            renderMembers();
            debouncedSave();
        };

        document.getElementById('btn-share').onclick = () => {
            try {
                // Construct URL correctly for shared environments
                const url = new URL(window.location.href);
                url.searchParams.set('session', state.sessionId);
                const shareUrl = url.toString();
                
                // Fallback method for clipboard copying
                const textArea = document.createElement("textarea");
                textArea.value = shareUrl;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                let success = false;
                try {
                    success = document.execCommand('copy');
                } catch (err) {
                    console.error('Copy command failed', err);
                }
                
                document.body.removeChild(textArea);
                
                if (success) {
                    const btn = document.getElementById('btn-share');
                    const txt = document.getElementById('share-text');
                    const oldText = txt.innerText;
                    txt.innerText = 'Link Disalin!';
                    btn.classList.replace('bg-emerald-600', 'bg-green-500');
                    setTimeout(() => { txt.innerText = oldText; btn.classList.replace('bg-green-500', 'bg-emerald-600'); }, 2000);
                } else {
                    prompt("Salin link ini secara manual:", shareUrl);
                }
            } catch (e) {
                console.error("Share Link Error:", e);
                alert(`Gagal menyalin link. Session ID Anda adalah: ${state.sessionId}`);
            }
        };

        // --- INITIALIZATION ---
        const startSync = (userId) => {
            if (!state.sessionId) return;
            
            const docRef = doc(db, 'akad_sessions', state.sessionId);
            
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    
                    // Update state but keep local focus
                    state.generalData = data.generalData || state.generalData;
                    
                    // Selective update for members to prevent overwrite
                    if (data.members) {
                        state.members = data.members;
                        renderMembers();
                    }
                    
                    document.getElementById('input-start-date').value = state.generalData.startDate;
                    document.getElementById('input-frequency').value = state.generalData.frequency;
                    
                    state.syncStatus = 'saved';
                    state.syncError = null;
                } else {
                    debouncedSave();
                }
                updateSyncUI();
            }, (error) => {
                console.error("Firestore Sync Error:", error);
                state.syncStatus = 'error';
                state.syncError = error?.message || 'Sync failed';
                updateSyncUI();
            });
        };

        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            state.sessionId = params.get('session');
            
            if (!state.sessionId) {
                state.sessionId = crypto.randomUUID();
            }

            document.getElementById('preview-no-akad').innerText = `Nomor: ${state.sessionId.slice(0,6).toUpperCase()}/SYR/${new Date().getFullYear()}`;

            // RULE 3: Perform Auth before any Firestore query
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Authentication failed:", e);
                    state.syncStatus = 'error';
                    state.syncError = e?.message || 'Auth failed';
                    updateSyncUI();
                }
            };

            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    startSync(user.uid);
                } else {
                    state.syncStatus = 'offline';
                    state.syncError = null;
                    updateSyncUI();
                }
            });

            await initAuth();

            // Bind global events
            document.getElementById('input-start-date').onchange = (e) => { state.generalData.startDate = e.target.value; renderPreview(); debouncedSave(); };
            document.getElementById('input-frequency').onchange = (e) => { state.generalData.frequency = e.target.value; renderPreview(); debouncedSave(); };

            renderMembers();
            updateSyncUI();
        };
    </script>
</body>
</html>
